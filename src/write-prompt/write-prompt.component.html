@if(currentStoryIndex >= playerStories.length) {
    <p>All stories have been submitted!</p>
} 
@else {
    <div class="story-so-far-section" [style.display]="hasPrequelContent ? 'block' : 'none'">
        <h3>Story so far</h3>
        <prequel-story-display
            [gameCode]="gameCode" 
            [story]="playerStories[currentStoryIndex]"
            [isAdventureMode]="false"
            (prequelPlayerOutput)="setPrequelPlayer($event)"
            (hasPrequelContent)="setHasPrequelContent($event)">
        </prequel-story-display>
    </div>
    
    @if (phase !== WritePhase.PROMPT) {
        <div class="story-container">
            @if (prompt.value) {
                <mat-card class="story">{{prompt.value}}</mat-card>
            }
            @if (phase === WritePhase.OPTION_ONE || phase === WritePhase.OPTION_TWO) {
                <div class="writing-button-container">
                    <div class="writing-buttons">
                        @if (optionOne.value) {
                            <button mat-flat-button disabled>{{optionOne.value}}</button>
                        } 
                        @if (optionTwo.value) {
                            <button mat-flat-button disabled>{{optionTwo.value}}</button>
                        }
                    </div>
                </div>
            }
        </div>
    }

    <!-- Writing Sections with Instructions beside each input -->
    <div class="writing-container">
        <!-- PROMPT Phase -->
        <div class="writing-section">
            @if (phase === WritePhase.PROMPT) {
                <div class="instructions-box" [class.active]="phase === WritePhase.PROMPT">
                    <div class="instructions">
                        @if (playerStories[currentStoryIndex].mainPlotStory) {
                            <div class="writing-stats">
                                What would happen to you if you encountered 
                                <mat-chip-set><mat-chip class="entity">{{favorStat.favorEntity}}</mat-chip></mat-chip-set>
                                @if(prequelPlayer.userName == "" || !isPlayerSequel) {
                                    while at the
                                    <mat-chip-set><mat-chip class="location">
                                    {{playerStories[currentStoryIndex].location.label}}
                                    </mat-chip></mat-chip-set> 
                                }
                                @if(prequelPlayer.userName != "") {
                                    @if (!isPlayerSequel) {
                                        as a result of 
                                        <mat-chip-set><mat-chip class="player">
                                        {{prequelPlayer.userName}}'s 
                                        </mat-chip></mat-chip-set>
                                        choice above
                                    } @else {
                                        if you had made 
                                        <mat-chip-set><mat-chip class="player">
                                        {{prequelPlayer.userName}}'s 
                                        </mat-chip></mat-chip-set>
                                        choice above
                                    }
                                }
                                ?
                            </div>
                        } @else {
                            <div class="writing-stats">
                                What is something that might happen to you 
                                @if(prequelPlayer.userName == "" || !isPlayerSequel) {
                                    at the
                                    <mat-chip-set><mat-chip class="location">
                                        {{playerStories[currentStoryIndex].location.label}}
                                    </mat-chip></mat-chip-set>
                                }
                                @if(prequelPlayer.userName != "") {
                                    @if (!isPlayerSequel) {
                                        as a result of 
                                        <mat-chip-set><mat-chip class="player">
                                        {{prequelPlayer.userName}}'s 
                                        </mat-chip></mat-chip-set>
                                        choice above
                                    } @else {
                                        if you had made 
                                        <mat-chip-set><mat-chip class="player">
                                        {{prequelPlayer.userName}}'s
                                        </mat-chip></mat-chip-set>
                                        choice above
                                    }
                                }
                                ?
                            </div>
                        }
                    </div>
                </div>
            }
            @if (phase === WritePhase.PROMPT) {
                <div class="writing-input-box">
                    <mat-form-field class="full-width" [class.disabled]="phase !== WritePhase.PROMPT">
                        <mat-label>Prompt</mat-label>
                        <textarea [formControl]="prompt" matInput placeholder="{{promptExample}}" maxlength="300" [disabled]="phase !== WritePhase.PROMPT"></textarea>
                        <mat-hint align="end">{{prompt.value?.length || 0}}/300</mat-hint>
                    </mat-form-field>
                </div>
                <div class="writing-button-container">
                    <div class="writing-buttons">
                        @if (writingHasProgressed) {
                            <button mat-flat-button (click)="goBack()" style="margin-right: 10px;">< Back</button>
                        }
                        <button mat-flat-button (click)="submitWriting()" [disabled]="!canSubmit()">{{aboutToSubmit ? "Submit" : "Next >"}}</button>
                    </div>
                </div>
            }
        </div>

        <!-- OPTION_ONE Phase -->
        @if (phase === WritePhase.PROMPT || phase === WritePhase.OPTION_ONE) {
            <div class="writing-section">
                @if (phase === WritePhase.OPTION_ONE) {
                    <div class="instructions-box" [class.active]="phase === WritePhase.OPTION_ONE">
                        <div class="instructions">
                            <div class="stat-chip-container">
                                <div class="writing-stats">
                                    @if (playerStories[currentStoryIndex].mainPlotStory) {
                                        What could you do to try to impress 
                                        <mat-chip-set><mat-chip class="entity">{{favorStat.favorEntity}}</mat-chip></mat-chip-set>
                                    } @else {
                                        What could you do to try to resolve the prompt you've written
                                    }
                                using
                                <mat-chip-set><mat-chip class="stat">
                                    {{playerStories[currentStoryIndex].options[0].playerStatDCs[0].statType.label}}
                                    @if (playerStories[currentStoryIndex].options[0].playerStatDCs[0].statType.favorType) {
                                        with {{playerStories[currentStoryIndex].options[0].playerStatDCs[0].statType.favorEntity}}
                                    }
                                    <span class="difficulty-badge">{{statDCDifficulty(0)}}</span>
                                </mat-chip></mat-chip-set>?
                                </div>
                            </div>
                        </div>
                    </div>
                }
            <div class="writing-input-box">
                <mat-form-field class="full-width" [class.disabled]="phase !== WritePhase.OPTION_ONE">
                    <mat-label>You could...</mat-label>
                    <input matInput placeholder="{{optionOneExample}}" id="optionOne" [formControl]="optionOne" maxlength="40" [disabled]="phase !== WritePhase.OPTION_ONE">
                    <mat-hint align="end">{{optionOne.value?.length || 0}}/40</mat-hint>
                </mat-form-field>
            </div>
            @if (phase === WritePhase.OPTION_ONE) {
                <div class="writing-button-container">
                    <div class="writing-buttons">
                        @if (writingHasProgressed) {
                            <button mat-flat-button (click)="goBack()" style="margin-right: 10px;">< Back</button>
                        }
                        <button mat-flat-button (click)="submitWriting()" [disabled]="!canSubmit()">{{aboutToSubmit ? "Submit" : "Next >"}}</button>
                    </div>
                </div>
            }
        </div>
    }

        
        <!-- OPTION_TWO Phase -->
        <div class="writing-section">
            @if (phase === WritePhase.OPTION_TWO) {
                <div class="instructions-box" [class.active]="phase === WritePhase.OPTION_TWO">
                    <div class="instructions">
                        <div class="stat-chip-container">
                            <div class="writing-stats">
                                @if (playerStories[currentStoryIndex].mainPlotStory) {
                                    What could you do to try to weaken 
                                    <mat-chip-set><mat-chip class="entity">{{favorStat.favorEntity}}</mat-chip></mat-chip-set>
                                } @else {
                                    What could you do to try to resolve the prompt you've written
                                }
                                using
                                <mat-chip-set><mat-chip class="stat">
                                    {{playerStories[currentStoryIndex].options[1].playerStatDCs[0].statType.label}}
                                    @if (playerStories[currentStoryIndex].options[1].playerStatDCs[0].statType.favorType) {
                                        with {{playerStories[currentStoryIndex].options[1].playerStatDCs[0].statType.favorEntity}}
                                    }
                                    <span class="difficulty-badge">{{statDCDifficulty(1)}}</span>
                                </mat-chip></mat-chip-set>?
                            </div>

                        </div>
                    </div>
                </div>
            }
            <div class="writing-input-box">
                <mat-form-field class="full-width" [class.disabled]="phase !== WritePhase.OPTION_TWO">
                    <mat-label>Or you could...</mat-label>
                    <input matInput placeholder="{{optionTwoExample}}" id="optionTwo" [formControl]="optionTwo" maxlength="40" [disabled]="phase !== WritePhase.OPTION_TWO">
                    <mat-hint align="end">{{optionTwo.value?.length || 0}}/40</mat-hint>
                </mat-form-field>
            </div>
            @if (phase === WritePhase.OPTION_TWO) {
                <div class="writing-button-container">
                    <div class="writing-buttons">
                        @if (writingHasProgressed) {
                            <button mat-flat-button (click)="goBack()" style="margin-right: 10px;">< Back</button>
                        }
                        <button mat-flat-button (click)="submitWriting()" [disabled]="!canSubmit()">{{aboutToSubmit ? "Submit" : "Next >"}}</button>
                    </div>
                </div>
            }
        </div>
    </div>

}