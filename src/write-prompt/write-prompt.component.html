@if(currentStoryIndex >= playerStories.length) {
    <p>All stories have been submitted!</p>
} 
@else {

    <div class="instructions">
        @if (phase === WritePhase.PROMPT) {
            @if (playerStories[currentStoryIndex].mainPlotStory) {
                Now create a one or two sentence description of an encounter with {{favorStat.favorEntity}} where you must choose to help or harm them! Someone else will get this encounter on their turn!
            } @else {
                Create a one to two sentence description of an encounter that someone else will have on their turn!
            }
        }
        @if (phase === WritePhase.OPTION_ONE || phase === WritePhase.OPTION_TWO) {
            @if(playerStories[currentStoryIndex].mainPlotStory) {
                This is a main plot story! Start by describing some things about {{favorStat.favorEntity}}.
            } @else {
                Now list something you could try to resolve this prompt. These are just options! Someone else will write the outcomes.
            }
        }
    </div><br>

    <section>
        <div class="instructions-question">
            @if (phase === WritePhase.PROMPT) {
                @if (playerStories[currentStoryIndex].mainPlotStory) {
                    <div class="writing-stats">
                        What would {{favorStat.favorEntity}} be doing at the
                        <mat-chip-set><mat-chip class="stat">
                        {{playerStories[currentStoryIndex].location.label}}
                        </mat-chip></mat-chip-set>?
                    </div>
                } @else {
                    <div class="writing-stats">
                        What is something that might happen in the
                        <mat-chip-set><mat-chip class="stat">
                        {{playerStories[currentStoryIndex].location.label}}
                        </mat-chip></mat-chip-set>?
                    </div>
                }
            }

            @if (phase === WritePhase.OPTION_ONE || phase === WritePhase.OPTION_TWO) {
                <div class="writing-stats">
                    {{getInstructionQuestionString(getCurrentOptionIndex())}}
                    <mat-chip-set><mat-chip class="stat">
                        {{playerStories[currentStoryIndex].options[getCurrentOptionIndex()].playerStatDCs[0].statType.label}}
                        @if (playerStories[currentStoryIndex].options[getCurrentOptionIndex()].playerStatDCs[0].statType.favorType) {
                            with {{playerStories[currentStoryIndex].options[getCurrentOptionIndex()].playerStatDCs[0].statType.favorEntity}}
                        }
                        [{{statDCDifficulty(getCurrentOptionIndex())}} difficulty]
                    </mat-chip></mat-chip-set>?
                </div>
            }
        </div><br>
        
        <prequel-story-display
            [gameCode]="gameCode" 
            [story]="playerStories[currentStoryIndex]"
            [isAdventureMode]="false">
        </prequel-story-display>

        <mat-chip-set>
            @if (phase === WritePhase.PROMPT) {
                <mat-chip class="progress">{{numberOfPromptsWritten}} / {{numberOfPromptsToWrite}} Prompts Written</mat-chip>
            }
            @if (phase === WritePhase.OPTION_ONE || phase === WritePhase.OPTION_TWO) {
                <mat-chip class="progress">{{getCurrentOptionIndex()}}/2 Options Written</mat-chip>
            }
        </mat-chip-set><br>
    </section>

    <mat-divider></mat-divider><br>
    @if (prompt.value || optionOne.value || optionTwo.value) {
        <div>Story Preview:</div><br>
    } @else {
        <div>Story Example:</div><br>
    }

    @if (prompt.value) {
        <mat-card class="story">{{prompt.value}}</mat-card><br>
    } @else {
        <mat-card class="story">{{promptExample}}</mat-card><br>
    }

    <div class="writing-button-container">
        <div class="writing-buttons">
            @if (optionOne.value) {
                <button mat-flat-button disabled>{{optionOne.value}}</button>
            } @else {
                <button mat-flat-button disabled>{{optionOneExample}}</button>
            }
            @if (optionTwo.value) {
                <button mat-flat-button disabled>{{optionTwo.value}}</button>
            } @else {
                <button mat-flat-button disabled>{{optionTwoExample}}</button>
            }
        </div><br>
    </div>
    <br>
    <mat-divider></mat-divider><br>

    @if (phase === WritePhase.PROMPT) {
        <mat-form-field class="full-width">
            <mat-label>Prompt</mat-label>
            <textarea [formControl]="prompt" matInput placeholder="{{promptExample}}" maxlength="300"></textarea>
            <mat-hint align="end">{{prompt.value?.length || 0}}/300</mat-hint>
        </mat-form-field>
    }

    @if(phase === WritePhase.OPTION_ONE) {
        <mat-form-field class="full-width">
            <mat-label>You could...</mat-label>
            <input matInput placeholder="{{optionOneExample}}" id="optionOne" [formControl]="optionOne" maxlength="40">
            <mat-hint align="end">{{optionOne.value?.length || 0}}/40</mat-hint>
        </mat-form-field>
    }

    @if(phase === WritePhase.OPTION_TWO) {
        <mat-form-field class="full-width">
            <mat-label>You could...</mat-label>
            <input matInput placeholder="{{optionTwoExample}}"  id="optionTwo" [formControl]="optionTwo" maxlength="40">
            <mat-hint align="end">{{optionTwo.value?.length || 0}}/40</mat-hint>
        </mat-form-field>
    }

    <div class="writing-button-container">
        <div class="writing-buttons">
            @if (writingHasProgressed) {
                <button mat-flat-button (click)="goBack()" style="margin-right: 10px;">< Back</button>
            }
            <button mat-flat-button (click)="submitWriting()" [disabled]="!canSubmit()">{{aboutToSubmit ? "Submit" : "Next >"}}</button>
        </div>
    </div>
}