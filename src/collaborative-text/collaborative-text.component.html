<div class="collaborative-text-container">
  <div class="phase-header">
    <h2>{{ phaseQuestion }}</h2>
    <p class="instructions">{{ phaseInstructions }}</p>
    @if (phaseInstructions && collaborativeMode) {
      <p class="instructions">
        <span class="collaborative-mode-title">{{ getCollaborativeModeLabel() }}</span>
        <span [innerHTML]="collaborativeModeInstructions"></span>
      </p>
    }
  </div>

  <!-- Outcome Types Selection (Streamlined Mode) -->
  @if (isStreamlinedMode && (!hasSubmitted || isSimpleMode) && availableOutcomeTypes.length > 0) {
    <mat-card class="outcome-types-card">
      <mat-card-header>
        <mat-card-title>Choose an Option</mat-card-title>
        <mat-card-subtitle>Select one to write about</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="outcome-types-scroll">
          @for (outcomeType of availableOutcomeTypes; track outcomeType.id) {
            <div class="outcome-type-wrapper" [class.has-subtypes]="outcomeType.subTypes && outcomeType.subTypes.length > 0">
              @if (selectedOutcomeType?.id === outcomeType.id && selectedStory) {
                <div class="story-display">
                  @if (selectedStory.encounterLabel?.encounterLabel) {
                    <p class="encounter-label-text">When we encountered {{ selectedStory.encounterLabel?.encounterLabel }} last time</p>
                  }
                  <mat-card class="submission-item">
                    <mat-card-content>
                      <div class="submission-preview">
                        <p class="submission-text">{{ selectedStory.prompt }}</p>
                        @if (selectedStory.selectedOptionId) {
                          @for (option of selectedStory.options; track option.optionId) {
                            @if (option.optionId === selectedStory.selectedOptionId) {
                              <div class="outcome-badge outcome-success">
                                {{ option.optionText }}
                              </div>
                              <p class="submission-text">{{ option.successText }}</p>
                            }
                          }
                        }
                      </div>
                    </mat-card-content>
                  </mat-card>
                </div>
              }
              @if (outcomeType.subTypes && outcomeType.subTypes.length > 0) {
                <!-- Parent with subTypes -->
                <mat-card class="outcome-type-item parent-with-subtypes">
                  <mat-card-content>
                    <p class="parent-label">{{ outcomeType.label }}</p>
                    <div class="subtypes-container">
                      @for (subType of outcomeType.subTypes; track subType.id) {
                        <mat-card 
                          class="subtype-item"
                          [class.selected]="selectedOutcomeType?.subTypes?.[0]?.id === subType.id"
                          (click)="onSelectSubType(outcomeType, subType)">
                          <mat-card-content>
                            <p>{{ subType.label }}</p>
                          </mat-card-content>
                        </mat-card>
                      }
                    </div>
                  </mat-card-content>
                </mat-card>
              } @else {
                <!-- Regular outcomeType without subTypes -->
                <mat-card 
                  class="outcome-type-item"
                  [class.selected]="selectedOutcomeType?.id === outcomeType.id"
                  (click)="onSelectOutcomeType(outcomeType)">
                  <mat-card-content>
                    <p>{{ outcomeType.label }}</p>
                  </mat-card-content>
                </mat-card>
              }
            </div>
          }
        </div>
      </mat-card-content>
    </mat-card>
  }

  @if (isLoading) {
    <div class="loading-container">
      <mat-spinner diameter="40"></mat-spinner>
      <p>Loading collaborative text...</p>
    </div>
  } @else {
    <!-- New Submission Section -->
    @if (showNewSubmission || isSimpleMode) {
      <mat-card class="submission-card" [class.outcome-highlight]="playerOutcomeType || selectedOutcomeType" [ngClass]="(playerOutcomeType || selectedOutcomeType) ? getOutcomeTypeClass((selectedOutcomeType || playerOutcomeType)?.id) : ''">
        <mat-card-header>
          <mat-card-title>{{ phaseQuestion }}</mat-card-title>
          @if (selectedOutcomeType) {
            <mat-card-subtitle class="outcome-message">
              {{ selectedOutcomeType.subTypes && selectedOutcomeType.subTypes.length > 0 ? selectedOutcomeType.subTypes[0].label : selectedOutcomeType.label }}
            </mat-card-subtitle>
          } @else if (playerOutcomeType) {
            <mat-card-subtitle class="outcome-message">{{ playerOutcomeType.label }}</mat-card-subtitle>
          }
        </mat-card-header>
        <mat-card-content>
          @if (isSimpleMode) {
            <!-- Simple mode: text input for WHAT_DO_WE_FEAR and WHAT_ARE_WE_CAPABLE_OF -->
            @if (isWhatAreWeCapableOfPhase() && newTextControl.value) {
              Example:<br>
              <mat-card class="story">
                You gain +2 {{ newTextControl.value }}
              </mat-card><br>
            }
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>{{ getSimpleModeLabel() }}</mat-label>
              <input 
                matInput 
                [formControl]="newTextControl"
                [placeholder]="getSimpleModePlaceholder()"
                maxlength="30">
              <mat-hint align="end">{{ newTextControl.value?.length || 0 }}/30</mat-hint>
            </mat-form-field>
          } @else {
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>{{ phaseQuestion.toLowerCase() }}</mat-label>
              <textarea 
                matInput 
                [formControl]="newTextControl"
                placeholder="Be creative and descriptive..."
                rows="4"
                maxlength="200">
              </textarea>
              @if ((newTextControl.value?.length || 0) >= 150) {
                <mat-hint align="start" class="limit-warning">Submit so others can add to your idea!</mat-hint>
              }
              <mat-hint align="end">{{ newTextControl.value?.length || 0 }}/200</mat-hint>
            </mat-form-field>
          }
        </mat-card-content>
        <mat-card-actions class="actions-right">
          <button 
            mat-flat-button 
            color="primary" 
            (click)="onSubmitNewText()"
            [disabled]="newTextControl.invalid || isLoading || (isStreamlinedMode && availableOutcomeTypes.length > 0 && !selectedOutcomeType)">
            {{ getSubmitButtonText() }}
          </button>
        </mat-card-actions>
      </mat-card>
    }

    <!-- Existing Submissions Section (only for collaborative mode) -->
    @if (isCollaborativeMode && hasSubmitted && availableSubmissions.length > 0) {
      <mat-card class="submissions-card">
        <mat-card-header>
          <mat-card-title>Add to Other Players' Ideas</mat-card-title>
          <mat-card-subtitle>Choose a submission to build upon</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="submissions-grid">
            @for (submission of availableSubmissions; track submission.submissionId) {
              <mat-card 
                class="submission-item"
                [class.selected]="selectedSubmission?.submissionId === submission.submissionId"
                [class.outcome-highlight]="submission.outcomeType"
                [ngClass]="submission.outcomeType ? getOutcomeTypeClass(submission.outcomeType) : ''"
                (click)="onSelectSubmission(submission)">
                <mat-card-content>
                  <div class="submission-preview">
                    @if (submission.outcomeTypeWithLabel && submission.outcomeTypeWithLabel.subTypes && submission.outcomeTypeWithLabel.subTypes.length > 0) {
                      <p class="submission-text">
                        {{ submission.outcomeTypeWithLabel.label }}
                      </p>
                    }
                    @if (submission.outcomeType) {
                      <div class="outcome-badge" [ngClass]="getOutcomeTypeClass(submission.outcomeType)">
                        {{ getOutcomeTypeLabel(submission) }}
                        @if (isPlayerSubmission(submission)) {
                          <span class="your-submission">(Your submission)</span>
                        }
                      </div>
                    }
                    <p class="submission-text">{{ getSubmissionPreview(submission) }}</p>
                    <div class="submission-meta">
                      <mat-chip-set>
                        <!-- <mat-chip>{{ getSubmissionAuthor(submission) }}</mat-chip> -->
                        <mat-chip>{{ submission.additions.length || 0 }} additions</mat-chip>
                      </mat-chip-set>
                    </div>
                  </div>
                </mat-card-content>
              </mat-card>
            }
          </div>

          @if (selectedSubmission) {
            <div class="addition-section">
              <h4>Add to: "{{ getSubmissionPreview(selectedSubmission) }}"</h4>
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Your addition</mat-label>
                <textarea 
                  matInput 
                  [formControl]="additionTextControl"
                  placeholder="Add your ideas to build upon this submission..."
                  rows="3">
                </textarea>
                <mat-hint align="end">{{ additionTextControl.value?.length || 0 }} characters</mat-hint>
              </mat-form-field>
              <div class="addition-actions">
                <button 
                  mat-flat-button 
                  color="primary" 
                  (click)="onAddToSubmission()"
                  [disabled]="additionTextControl.invalid || isLoading">
                  Add to Submission
                </button>
                <button 
                  mat-button 
                  (click)="selectedSubmission = null">
                  Cancel
                </button>
              </div>
            </div>
          }
        </mat-card-content>
      </mat-card>
    }

    <!-- No Submissions Message (collaborative mode only) -->
    @if (isCollaborativeMode && hasSubmitted && availableSubmissions.length === 0) {
      <mat-card class="no-submissions-card">
        <mat-card-content>
          <div class="no-submissions-message">
            <mat-icon>group_work</mat-icon>
            <h3>Waiting for other players...</h3>
            <p>Other players haven't submitted their ideas yet. New submissions will appear automatically!</p>
          </div>
        </mat-card-content>
      </mat-card>
    }
  }
</div>
