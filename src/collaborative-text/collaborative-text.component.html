<div class="collaborative-text-container">
  <div class="phase-header">
    <h2>{{ phaseQuestion }}</h2>
    <p class="instructions">{{ phaseInstructions }}</p>
  </div>

  @if (isLoading) {
    <div class="loading-container">
      <mat-spinner diameter="40"></mat-spinner>
      <p>Loading collaborative text...</p>
    </div>
  } @else {
    <!-- New Submission Section -->
    @if (showNewSubmission || isSimpleMode) {
      <mat-card class="submission-card" [class.outcome-highlight]="isWhatWillBecomeOfUsPhase() && playerOutcomeType" [ngClass]="isWhatWillBecomeOfUsPhase() && playerOutcomeType ? getOutcomeTypeClass(playerOutcomeType) : ''">
        <mat-card-header>
          <mat-card-title>{{ phaseQuestion }}</mat-card-title>
          @if (isWhatWillBecomeOfUsPhase() && playerOutcomeType) {
            <mat-card-subtitle class="outcome-message">{{ getOutcomeTypeMessage(playerOutcomeType) }}</mat-card-subtitle>
          }
        </mat-card-header>
        <mat-card-content>
          @if (isSimpleMode) {
            <!-- Simple mode: text input for WHAT_DO_WE_FEAR and WHAT_ARE_WE_CAPABLE_OF -->
            @if (isWhatAreWeCapableOfPhase() && newTextControl.value) {
              Example:<br>
              <mat-card class="story">
                You gain +2 {{ newTextControl.value }}
              </mat-card><br>
            }
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>{{ getSimpleModeLabel() }}</mat-label>
              <input 
                matInput 
                [formControl]="newTextControl"
                [placeholder]="getSimpleModePlaceholder()"
                maxlength="30">
              <mat-hint align="end">{{ newTextControl.value?.length || 0 }}/30</mat-hint>
            </mat-form-field>
          } @else {
            <!-- Collaborative mode: textarea for WHERE_ARE_WE, WHO_ARE_WE, WHAT_IS_COMING -->
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>{{ phaseQuestion.toLowerCase() }}</mat-label>
              <textarea 
                matInput 
                [formControl]="newTextControl"
                placeholder="Be creative and descriptive..."
                rows="4">
              </textarea>
              <mat-hint align="end">{{ newTextControl.value?.length || 0 }} characters</mat-hint>
            </mat-form-field>
          }
        </mat-card-content>
        <mat-card-actions>
          <button 
            mat-flat-button 
            color="primary" 
            (click)="onSubmitNewText()"
            [disabled]="newTextControl.invalid || isLoading">
            {{ getSubmitButtonText() }}
          </button>
        </mat-card-actions>
      </mat-card>
    }

    <!-- Existing Submissions Section (only for collaborative mode) -->
    @if (isCollaborativeMode && hasSubmitted && availableSubmissions.length > 0) {
      <mat-card class="submissions-card">
        <mat-card-header>
          <mat-card-title>Add to Other Players' Ideas</mat-card-title>
          <mat-card-subtitle>Choose a submission to build upon</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="submissions-grid">
            @for (submission of availableSubmissions; track submission.submissionId) {
              <mat-card 
                class="submission-item"
                [class.selected]="selectedSubmission?.submissionId === submission.submissionId"
                [class.outcome-highlight]="isWhatWillBecomeOfUsPhase() && submission.outcomeType"
                [ngClass]="isWhatWillBecomeOfUsPhase() && submission.outcomeType ? getOutcomeTypeClass(submission.outcomeType) : ''"
                (click)="onSelectSubmission(submission)">
                <mat-card-content>
                  <div class="submission-preview">
                    @if (isWhatWillBecomeOfUsPhase() && submission.outcomeType) {
                      <div class="outcome-badge" [ngClass]="getOutcomeTypeClass(submission.outcomeType)">
                        {{ getOutcomeTypeLabel(submission.outcomeType) }} Ending
                        @if (isPlayerSubmission(submission)) {
                          <span class="your-submission">(Your submission)</span>
                        }
                      </div>
                    }
                    <p class="submission-text">{{ getSubmissionPreview(submission) }}</p>
                    <div class="submission-meta">
                      <mat-chip-set>
                        <!-- <mat-chip>{{ getSubmissionAuthor(submission) }}</mat-chip> -->
                        <mat-chip>{{ submission.additions.length || 0 }} additions</mat-chip>
                      </mat-chip-set>
                    </div>
                  </div>
                </mat-card-content>
              </mat-card>
            }
          </div>

          @if (selectedSubmission) {
            <div class="addition-section">
              <h4>Add to: "{{ getSubmissionPreview(selectedSubmission) }}"</h4>
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Your addition</mat-label>
                <textarea 
                  matInput 
                  [formControl]="additionTextControl"
                  placeholder="Add your ideas to build upon this submission..."
                  rows="3">
                </textarea>
                <mat-hint align="end">{{ additionTextControl.value?.length || 0 }} characters</mat-hint>
              </mat-form-field>
              <div class="addition-actions">
                <button 
                  mat-flat-button 
                  color="primary" 
                  (click)="onAddToSubmission()"
                  [disabled]="additionTextControl.invalid || isLoading">
                  Add to Submission
                </button>
                <button 
                  mat-button 
                  (click)="selectedSubmission = null">
                  Cancel
                </button>
              </div>
            </div>
          }
        </mat-card-content>
      </mat-card>
    }

    <!-- No Submissions Message (collaborative mode only) -->
    @if (isCollaborativeMode && hasSubmitted && availableSubmissions.length === 0) {
      <mat-card class="no-submissions-card">
        <mat-card-content>
          <div class="no-submissions-message">
            <mat-icon>group_work</mat-icon>
            <h3>Waiting for other players...</h3>
            <p>Other players haven't submitted their ideas yet. New submissions will appear automatically!</p>
          </div>
        </mat-card-content>
      </mat-card>
    }
  }
</div>
